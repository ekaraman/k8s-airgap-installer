---
# tasks file for helm_install
##################################################################
# KUBECTL KURULUMU
##################################################################

- name: Add Kubernetes yum repo
  copy:
    dest: /etc/yum.repos.d/kubernetes.repo
    mode: "0644"
    content: |
      [kubernetes]
      name=Kubernetes
      baseurl=https://pkgs.k8s.io/core:/stable:/v1.33/rpm/
      enabled=1
      gpgcheck=1
      gpgkey=https://pkgs.k8s.io/core:/stable:/v1.33/rpm/repodata/repomd.xml.key

- name: Install kubectl
  yum:
    name: kubectl
    state: present

- name: Check kubectl version
  command: kubectl version --client
  register: kubectl_version
  changed_when: false

- debug:
    var: kubectl_version.stdout

##################################################################
# HELM KURULUMU
##################################################################
#
- name: Ensure /usr/local/bin exists
  file:
    path: /usr/local/bin
    state: directory
    mode: "0755"

- name: Copy helm tarball to bastion
  copy:
    src: helm-v3.16.0-linux-amd64.tar.gz
    dest: /tmp/helm-v3.16.0-linux-amd64.tar.gz
    mode: "0644"

- name: Extract helm binary
  unarchive:
    src: /tmp/helm-v3.16.0-linux-amd64.tar.gz
    dest: /tmp/
    remote_src: yes

- name: Install helm binary
  copy:
    src: /tmp/linux-amd64/helm
    dest: /usr/local/bin/helm
    mode: "0755"

- name: Check helm version
  command: /usr/local/bin/helm version
  register: helm_version
  changed_when: false

- debug:
    var: helm_version.stdout

##################################################################
# KUBECONFIG KOPYALAMA (MASTER-01 â†’ BASTION)
##################################################################
- name: Copy admin.conf from master-01 to bastion
  delegate_to: master-01
  fetch:
    src: /etc/kubernetes/admin.conf
    dest: /tmp/admin.conf
    flat: yes

- name: Move kubeconfig into ~/.kube/config
  shell: |
    mkdir -p ~/.kube
    cp /tmp/admin.conf ~/.kube/config
    chmod 600 ~/.kube/config

- name: Test kubectl connectivity
  command: kubectl get nodes
  register: k8s_nodes
  changed_when: false

- debug:
    var: k8s_nodes.stdout
    var: helm_version.stdout


