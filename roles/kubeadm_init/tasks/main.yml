---
# tasks file for kubeadm_init
- name: Ensure /etc/kubernetes directory exists
  file:
    path: /etc/kubernetes
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Write kubeadm config
  template:
    src: kubeadm-config.yaml.j2
    dest: /etc/kubernetes/kubeadm-config.yaml

- name: Initialize Kubernetes control plane
  command: kubeadm init --config=/etc/kubernetes/kubeadm-config.yaml
  args:
    creates: /etc/kubernetes/admin.conf
  register: kubeadm_init

# Configure kubectl for root (so calico_install can use it)
- name: Create .kube directory
  file:
    path: /root/.kube
    state: directory
    mode: '0700'

- name: Copy admin.conf to root's kube config
  copy:
    src: /etc/kubernetes/admin.conf
    dest: /root/.kube/config
    remote_src: yes
    mode: '0600'

# ---- JOIN COMMANDS ----

# 1) Worker join command (base)
- name: Get join command for workers (base)
  command: kubeadm token create --print-join-command
  register: kubeadm_join_worker_cmd_raw

# İstersen base komutu da saklayabilirsin debug için
- name: Save worker join command as fact (with containerd)
  set_fact:
    kubeadm_join_worker_cmd_base: "{{ kubeadm_join_worker_cmd_raw.stdout }}"
    kubeadm_join_worker_cmd: >-
      {{ kubeadm_join_worker_cmd_raw.stdout }}
      --cri-socket=unix:///run/containerd/containerd.sock

# 2) Control-plane sertifikalarını upload et
- name: Upload control-plane certificates
  command: kubeadm init phase upload-certs --upload-certs
  register: kubeadm_upload_certs

- name: Save certificate key
  set_fact:
    kubeadm_certificate_key: "{{ kubeadm_upload_certs.stdout_lines[-1] }}"

# 3) Base join command for control-plane
- name: Get base join command for control-plane
  command: kubeadm token create --print-join-command
  register: kubeadm_join_cp_cmd_raw

- name: Save control-plane join command as fact (with containerd)
  set_fact:
    kubeadm_join_controlplane_cmd_base: "{{ kubeadm_join_cp_cmd_raw.stdout }}"
    kubeadm_join_controlplane_cmd: >-
      {{ kubeadm_join_cp_cmd_raw.stdout }}
      --control-plane
      --certificate-key {{ kubeadm_certificate_key }}
      --cri-socket=unix:///run/containerd/containerd.sock
